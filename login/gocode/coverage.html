
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>login: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">login/main.go (27.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package main

// Code originally imported from two sources, merged together and added some relevant stuff:
// -&gt; https://blog.logrocket.com/integrating-mongodb-go-applications/
// -&gt; https://gist.github.com/mschoebel/9398202

import (
        "context"
        "fmt"
        "net/http"
        "os"
        "strconv"

        "github.com/gorilla/mux"
        "github.com/gorilla/securecookie"
        "go.mongodb.org/mongo-driver/bson"
        "go.mongodb.org/mongo-driver/mongo"
        "go.mongodb.org/mongo-driver/mongo/options"
        "go.mongodb.org/mongo-driver/mongo/readpref"
)

var localhost = "127.0.0.1"

var http_port = 8000
var mongodb_port = 27017
var database_name = "login_app"
var collection_name = "users"
var username = "Ahmad"
var password = "Pass123"
var usersCollection *mongo.Collection

// cookie handling
var cookieHandler = securecookie.New(
        securecookie.GenerateRandomKey(64),
        securecookie.GenerateRandomKey(32))

func getUserName(request *http.Request) (userName string) <span class="cov8" title="1">{
        if cookie, err := request.Cookie("session"); err == nil </span><span class="cov0" title="0">{
                cookieValue := make(map[string]string)
                if err = cookieHandler.Decode("session", cookie.Value, &amp;cookieValue); err == nil </span><span class="cov0" title="0">{
                        userName = cookieValue["name"]
                }</span>
        }
        <span class="cov8" title="1">return userName</span>
}

func setSession(userName string, response http.ResponseWriter) <span class="cov0" title="0">{
        value := map[string]string{
                "name": userName,
        }
        if encoded, err := cookieHandler.Encode("session", value); err == nil </span><span class="cov0" title="0">{
                cookie := &amp;http.Cookie{
                        Name:  "session",
                        Value: encoded,
                        Path:  "/",
                }
                http.SetCookie(response, cookie)
        }</span>
}

func clearSession(response http.ResponseWriter) <span class="cov8" title="1">{
        cookie := &amp;http.Cookie{
                Name:   "session",
                Value:  "",
                Path:   "/",
                MaxAge: -1,
        }
        http.SetCookie(response, cookie)
}</span>

// login handler

func loginHandler(response http.ResponseWriter, request *http.Request) <span class="cov8" title="1">{
        name := request.FormValue("name")
        pass := request.FormValue("password")
        redirectTarget := "/"
        ok := verifyCredentials(name, pass)
        if ok </span><span class="cov0" title="0">{

                setSession(name, response)
                redirectTarget = "/internal"
        }</span> else<span class="cov8" title="1"> {
                // print invalid login
                fmt.Fprintf(response, "&lt;h1&gt;Invalid login&lt;/h1&gt;&lt;a href=\"/\"&gt;Try again&lt;/a&gt;")
        }</span>
        <span class="cov8" title="1">http.Redirect(response, request, redirectTarget, http.StatusFound)</span>
}

// logout handler

func logoutHandler(response http.ResponseWriter, request *http.Request) <span class="cov8" title="1">{
        clearSession(response)
        http.Redirect(response, request, "/", http.StatusFound)
}</span>

// index page

const indexPage = `
&lt;h1&gt;Login&lt;/h1&gt;
&lt;form method="post" action="/login"&gt;
    &lt;label for="name"&gt;User name&lt;/label&gt;
    &lt;input type="text" id="name" name="name"&gt;
    &lt;label for="password"&gt;Password&lt;/label&gt;
    &lt;input type="password" id="password" name="password"&gt;
    &lt;button type="submit"&gt;Login&lt;/button&gt;
&lt;/form&gt;
`

func indexPageHandler(response http.ResponseWriter, request *http.Request) <span class="cov8" title="1">{
        fmt.Fprint(response, indexPage)
}</span>

// internal page

const internalPage = `
&lt;h1&gt;Internal&lt;/h1&gt;
&lt;hr&gt;
&lt;small&gt;You're welcome %s&lt;/small&gt;
&lt;form method="post" action="/logout"&gt;
    &lt;button type="submit"&gt;Logout&lt;/button&gt;
&lt;/form&gt;
`

func internalPageHandler(response http.ResponseWriter, request *http.Request) <span class="cov8" title="1">{
        userName := getUserName(request)
        if userName != "" </span><span class="cov0" title="0">{
                fmt.Fprintf(response, internalPage, userName)
        }</span> else<span class="cov8" title="1"> {
                http.Redirect(response, request, "/", http.StatusFound)
        }</span>
}

// server main method

var router = mux.NewRouter()

func main() <span class="cov0" title="0">{

        var mongodb_ip = ""
        if len(os.Args) &gt; 1 </span><span class="cov0" title="0">{
                if os.Args[1] == "" </span><span class="cov0" title="0">{
                        mongodb_ip = localhost
                }</span> else<span class="cov0" title="0"> {
                        mongodb_ip = os.Args[1]
                }</span>
        } else<span class="cov0" title="0"> {
                mongodb_ip = localhost
        }</span>
        <span class="cov0" title="0">fmt.Println("Mongodb IP: ", mongodb_ip)
        usersCollection = connectDB(mongodb_ip)
        if usersCollection != nil </span><span class="cov0" title="0">{
                createUsers()
        }</span> else<span class="cov0" title="0"> {
                fmt.Println("Warning: Running without database connection. Login will use hardcoded credentials.")
        }</span>
        <span class="cov0" title="0">router.HandleFunc("/", indexPageHandler)
        router.HandleFunc("/internal", internalPageHandler)

        router.HandleFunc("/login", loginHandler).Methods("POST")
        router.HandleFunc("/logout", logoutHandler).Methods("POST")

        http.Handle("/", router)
        fmt.Printf("Server starting on port %d...\n", http_port)
        err := http.ListenAndServe(":"+strconv.Itoa(http_port), nil)
        if err != nil </span><span class="cov0" title="0">{
                fmt.Printf("Failed to start server: %v\n", err)
        }</span>
}

func connectDB(mongodb_ip string) *mongo.Collection <span class="cov0" title="0">{
        fmt.Println(mongodb_ip)
        client, err := mongo.Connect(context.TODO(), options.Client().ApplyURI("mongodb://"+mongodb_ip+":"+strconv.Itoa(mongodb_port)+"/"))
        if err != nil </span><span class="cov0" title="0">{
                fmt.Printf("Failed to connect to MongoDB: %v\n", err)
                return nil
        }</span>
        <span class="cov0" title="0">if err := client.Ping(context.TODO(), readpref.Primary()); err != nil </span><span class="cov0" title="0">{
                fmt.Printf("Failed to ping MongoDB: %v\n", err)
                return nil
        }</span>

        <span class="cov0" title="0">db := client.Database(database_name)
        db.CreateCollection(context.TODO(), collection_name)
        fmt.Println("Successfully connected to MongoDB")
        return db.Collection(collection_name)</span>
}

func createUsers() <span class="cov0" title="0">{
        if usersCollection == nil </span><span class="cov0" title="0">{
                fmt.Println("Skipping user creation - no database connection")
                return
        }</span>
        // insert a single document into a collection
        // create a bson.D object
        <span class="cov0" title="0">user := bson.D{{Key: "username", Value: username}, {Key: "password", Value: password}}
        // insert the bson object using InsertOne()
        _, err := usersCollection.InsertOne(context.TODO(), user)
        // check for errors in the insertion
        if err != nil </span><span class="cov0" title="0">{
                fmt.Printf("Failed to create user: %v\n", err)
        }</span> else<span class="cov0" title="0"> {
                fmt.Println("Default user created successfully")
        }</span>
}

func verifyCredentials(user string, pass string) bool <span class="cov8" title="1">{
        // If no database connection, use hardcoded credentials for demonstration
        if usersCollection == nil </span><span class="cov8" title="1">{
                fmt.Println("Using hardcoded credentials (no database)")
                return user == username &amp;&amp; pass == password
        }</span>

        // retrieve single and multiple documents with a specified filter using FindOne() and Find()
        // create a search filer
        //filter := bson.D{{Key: "username:", Value: user}, {Key: "password", Value: pass}}
        <span class="cov0" title="0">filter := bson.D{
                {Key: "username", Value: user},
                {Key: "password", Value: pass},
        }

        var result bson.D
        err := usersCollection.FindOne(context.TODO(), filter).Decode(&amp;result)
        return err == nil</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
